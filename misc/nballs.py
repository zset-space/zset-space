"""
N-Ball Geometry Analysis Suite
==================================================

Dimension d = 0.25 (0.25)
----------------------------------------
Volume:          1.22521265
Surface:         0.30630316
Next Surface:    2.85129667
Coupling Ratio:  0.37038302
S/V Ratio:      0.25000000
Geom Freedom:   0.07659472
Phase:          0.35471677

Dimension d = 0.5 (0.5)
----------------------------------------
Volume:          1.46881258
Surface:         0.73440629
Next Surface:    3.85131113
Coupling Ratio:  0.41731342
S/V Ratio:      0.50000000
Geom Freedom:   0.36749278
Phase:          0.39534207

Dimension d = 0.75 (0.75)
----------------------------------------
Volume:          1.72811113
Surface:         1.29608335
Next Surface:    4.99744671
Coupling Ratio:  0.46025301
S/V Ratio:      0.75000000
Geom Freedom:   0.97306418
Phase:          0.43134754

Dimension d = 1.0 (1.0)
----------------------------------------
Volume:          2.00000000
Surface:         2.00000000
Next Surface:    6.28318531
Coupling Ratio:  0.50000000
S/V Ratio:      1.00000000
Geom Freedom:   2.00000000
Phase:          0.46364761

Dimension d = 1.25 (1.25)
----------------------------------------
Volume:          2.28103734
Surface:         2.85129667
Next Surface:    7.69823811
Coupling Ratio:  0.53712959
S/V Ratio:      1.25000000
Geom Freedom:   3.55121565
Phase:          0.49290823

Dimension d = plastic (1.324718)
----------------------------------------
Volume:          2.36626415
Surface:         3.13463271
Next Surface:    8.14429230
Coupling Ratio:  0.54778516
S/V Ratio:      1.32471800
Geom Freedom:   4.12991840
Phase:          0.50114117

Dimension d = 1.5 (1.5)
----------------------------------------
Volume:          2.56754075
Surface:         3.85131113
Next Surface:    9.22882164
Coupling Ratio:  0.57206982
S/V Ratio:      1.50000000
Geom Freedom:   5.71085529
Phase:          0.51962939

Dimension d = golden (1.618034)
----------------------------------------
Volume:          2.70361603
Surface:         4.37454266
Next Surface:    9.98688268
Coupling Ratio:  0.58790218
S/V Ratio:      1.61803400
Geom Freedom:   6.95701181
Phase:          0.53147655

Dimension d = 1.75 (1.75)
----------------------------------------
Volume:          2.85568383
Surface:         4.99744671
Next Surface:    10.85804244
Coupling Ratio:  0.60514792
S/V Ratio:      1.75000000
Geom Freedom:   8.52430370
Phase:          0.54419614

Dimension d = 2.0 (2.0)
----------------------------------------
Volume:          3.14159265
Surface:         6.28318531
Next Surface:    12.56637061
Coupling Ratio:  0.63661977
S/V Ratio:      2.00000000
Geom Freedom:   11.97437535
Phase:          0.56691150

Dimension d = 2.25 (2.25)
----------------------------------------
Volume:          3.42143916
Surface:         7.69823811
Next Surface:    14.33218029
Coupling Ratio:  0.66668943
S/V Ratio:      2.25000000
Geom Freedom:   15.95650308
Phase:          0.58801837

Dimension d = 2.5 (2.5)
----------------------------------------
Volume:          3.69152866
Surface:         9.22882164
Next Surface:    16.13233434
Coupling Ratio:  0.69552237
S/V Ratio:      2.50000000
Geom Freedom:   20.25752094
Phase:          0.60771452

Dimension d = e (2.718281828459045)
----------------------------------------
Volume:          3.91663882
Surface:         10.64652813
Next Surface:    17.71336482
Coupling Ratio:  0.71979309
S/V Ratio:      2.71828183
Geom Freedom:   24.01553572
Phase:          0.62388677

Dimension d = 2.75 (2.75)
----------------------------------------
Volume:          3.94837907
Surface:         10.85804244
Next Surface:    17.94279070
Coupling Ratio:  0.72325473
S/V Ratio:      2.75000000
Geom Freedom:   24.54408515
Phase:          0.62616327

Dimension d = 3.0 (3.0)
----------------------------------------
Volume:          4.18879020
Surface:         12.56637061
Next Surface:    19.73920880
Coupling Ratio:  0.75000000
S/V Ratio:      3.00000000
Geom Freedom:   28.36734393
Phase:          0.64350111

Dimension d = pi (3.141592653589793)
----------------------------------------
Volume:          4.31655917
Surface:         13.56087056
Next Surface:    20.74126506
Coupling Ratio:  0.76474681
S/V Ratio:      3.14159265
Geom Freedom:   30.12549698
Phase:          0.65287246

Dimension d = 3.25 (3.25)
----------------------------------------
Volume:          4.40990163
Surface:         14.33218029
Next Surface:    21.49753627
Coupling Ratio:  0.77585385
S/V Ratio:      3.25000000
Geom Freedom:   31.18960436
Phase:          0.65984330

Dimension d = 3.5 (3.5)
----------------------------------------
Volume:          4.60923838
Surface:         16.13233434
Next Surface:    23.19455862
Coupling Ratio:  0.80089775
S/V Ratio:      3.50000000
Geom Freedom:   32.43609270
Phase:          0.67528811

Dimension d = 3.75 (3.75)
----------------------------------------
Volume:          4.78474419
Surface:         17.94279070
Next Surface:    24.80839736
Coupling Ratio:  0.82520171
S/V Ratio:      3.75000000
Geom Freedom:   31.57048439
Phase:          0.68992005

Dimension d = 4.0 (4.0)
----------------------------------------
Volume:          4.93480220
Surface:         19.73920880
Next Surface:    26.31894507
Coupling Ratio:  0.84882636
S/V Ratio:      4.00000000
Geom Freedom:   28.18722523
Phase:          0.70381231

Dimension d = 4.25 (4.25)
----------------------------------------
Volume:          5.05824383
Surface:         21.49753627
Next Surface:    27.70822911
Coupling Ratio:  0.87182464
S/V Ratio:      4.25000000
Geom Freedom:   22.10783060
Phase:          0.71702874

Dimension d = 4.5 (4.5)
----------------------------------------
Volume:          5.15434636
Surface:         23.19455862
Next Surface:    28.96069888
Coupling Ratio:  0.89424304
S/V Ratio:      4.50000000
Geom Freedom:   13.46376749
Phase:          0.72962534

Dimension d = 4.75 (4.75)
----------------------------------------
Volume:          5.22282050
Surface:         24.80839736
Next Surface:    30.06343437
Coupling Ratio:  0.91612266
S/V Ratio:      4.75000000
Geom Freedom:   2.74668902
Phase:          0.74165157

Dimension d = 5.0 (5.0)
----------------------------------------
Volume:          5.26378901
Surface:         26.31894507
Next Surface:    31.00627668
Coupling Ratio:  0.93750000
S/V Ratio:      5.00000000
Geom Freedom:   9.19114457
Phase:          0.75315128

Dimension d = 5.25 (5.25)
----------------------------------------
Volume:          5.27775793
Surface:         27.70822911
Next Surface:    31.78188330
Coupling Ratio:  0.95840770
S/V Ratio:      5.25000000
Geom Freedom:   21.19705052
Phase:          0.76416354

Dimension d = V-max (5.256946)
----------------------------------------
Volume:          5.27776802
Surface:         27.74494149
Next Surface:    31.80099466
Coupling Ratio:  0.95898218
S/V Ratio:      5.25694600
Geom Freedom:   21.51893776
Phase:          0.76446289

Dimension d = tau-1 (5.283185307179586)
----------------------------------------
Volume:          5.27762423
Surface:         27.88266680
Next Surface:    31.87199065
Coupling Ratio:  0.96114930
S/V Ratio:      5.28318531
Geom Freedom:   22.72559253
Phase:          0.76559059

Dimension d = 5.5 (5.5)
----------------------------------------
Volume:          5.26558161
Surface:         28.96069888
Next Surface:    32.38571331
Coupling Ratio:  0.97887503
S/V Ratio:      5.50000000
Geom Freedom:   31.93942421
Phase:          0.77472333

Dimension d = 5.75 (5.75)
----------------------------------------
Volume:          5.22842337
Surface:         30.06343437
Next Surface:    32.81594901
Coupling Ratio:  0.99892838
S/V Ratio:      5.75000000
Geom Freedom:   40.07912123
Phase:          0.78486207

Dimension d = 6.0 (6.0)
----------------------------------------
Volume:          5.16771278
Surface:         31.00627668
Next Surface:    33.07336179
Coupling Ratio:  1.01859164
S/V Ratio:      6.00000000
Geom Freedom:   44.46751635
Phase:          0.79460810

Dimension d = 6.25 (6.25)
----------------------------------------
Volume:          5.08510133
Surface:         31.78188330
Next Surface:    33.16113105
Coupling Ratio:  1.03788648
S/V Ratio:      6.25000000
Geom Freedom:   44.33936114
Phase:          0.80398709

Dimension d = tau (6.283185307179586)
----------------------------------------
Volume:          5.07258486
Surface:         31.87199065
Next Surface:    33.16029103
Coupling Ratio:  1.04042108
S/V Ratio:      6.28318531
Geom Freedom:   43.96354230
Phase:          0.80520574

Dimension d = 6.5 (6.5)
----------------------------------------
Volume:          4.98241743
Surface:         32.38571331
Next Surface:    33.08462503
Coupling Ratio:  1.05683269
S/V Ratio:      6.50000000
Geom Freedom:   39.46535106
Phase:          0.81302230

Dimension d = 6.75 (6.75)
----------------------------------------
Volume:          4.86162208
Surface:         32.81594901
Next Surface:    32.85115289
Coupling Ratio:  1.07544834
S/V Ratio:      6.75000000
Geom Freedom:   30.23293486
Phase:          0.82173495

Dimension d = 7.0 (7.0)
----------------------------------------
Volume:          4.72476597
Surface:         33.07336179
Next Surface:    32.46969701
Coupling Ratio:  1.09375000
S/V Ratio:      7.00000000
Geom Freedom:   17.63430368
Phase:          0.83014439

Dimension d = 7.25 (7.25)
----------------------------------------
Volume:          4.57394911
Surface:         33.16113105
Next Surface:    31.95063395
Coupling Ratio:  1.11175293
S/V Ratio:      7.25000000
Geom Freedom:   3.15608349
Phase:          0.83826836

Dimension d = SA-max (7.256946)
----------------------------------------
Volume:          4.56957989
Surface:         33.16119448
Next Surface:    31.93435621
Coupling Ratio:  1.11224900
S/V Ratio:      7.25694600
Geom Freedom:   2.74385293
Phase:          0.83849016

Dimension d = tau+1 (7.283185307179586)
----------------------------------------
Volume:          4.55299290
Surface:         33.16029103
Next Surface:    31.87199065
Coupling Ratio:  1.11412097
S/V Ratio:      7.28318531
Geom Freedom:   1.18661717
Phase:          0.83932616

Dimension d = 7.5 (7.5)
----------------------------------------
Volume:          4.41128334
Surface:         33.08462503
Next Surface:    31.30545201
Coupling Ratio:  1.12947119
S/V Ratio:      7.50000000
Geom Freedom:   11.41685847
Phase:          0.84612310

Dimension d = 7.75 (7.75)
----------------------------------------
Volume:          4.23885844
Surface:         32.85115289
Next Surface:    30.54647239
Coupling Ratio:  1.14691777
S/V Ratio:      7.75000000
Geom Freedom:   24.25447819
Phase:          0.85372359

Dimension d = 8.0 (8.0)
----------------------------------------
Volume:          4.05871213
Surface:         32.46969701
Next Surface:    29.68658012
Coupling Ratio:  1.16410473
S/V Ratio:      8.00000000
Geom Freedom:   33.75064716
Phase:          0.86108362
"""

import numpy as np
from math import gamma, tau, pi, e

import matplotlib.pyplot
matplotlib.use('Agg')

class NBallAnalyzer:

    def dimensions(self, start=1, count=8, split=4, special=True):
        # Define the dimensions
        dimensions = {k/split: str(k/split) for k in range(start, (split*count)+1)}
        return sorted((dimensions if not special else dimensions | {
            0.5: '0.5',
            1.324718: 'plastic',
            1.618034: 'golden',
            e: 'e',
            pi: 'pi',
            5.256946: 'V-max',
            tau - 1: 'tau-1',
            tau: 'tau',
            7.256946: 'SA-max',
            tau + 1: 'tau+1',
        }).items())

    def ball_volume(self, d):
        if d < 0:
            return 0
        try:
            return (pi ** (d / 2)) / gamma(d / 2 + 1)
        except:
            return 0

    def ball_surface(self, d):
        if d < 0:
            return 0
        try:
            return tau * (pi ** ((d - 2) / 2)) / gamma(d / 2)
        except:
            return 0

    def ball_radius(self, d, volume=1):
        if d <= 0:
            return 0
        try:
            return (volume * gamma(d / 2 + 1) / (pi ** (d / 2))) ** (1 / d)
        except:
            return 0

    def coupling_ratio(self, d):
        v_d = self.ball_volume(d)
        s_d1 = self.ball_surface(d + 1)
        if abs(v_d) < 1e-15:
            return 0
        return s_d1 / (tau * v_d)

    def geometric_freedom(self, d):
        v = self.ball_volume(d)
        s = self.ball_surface(d)
        if abs(v) < 1e-15:
            return 0
        theta = np.arctan2(s, tau * v)
        r = (s ** 2 + (tau * v) ** 2) ** 0.5
        return r * abs(np.sin(theta * d))

    def analyze_dimension(self, d):
        v_d = self.ball_volume(d)
        s_d = self.ball_surface(d)
        s_d1 = self.ball_surface(d + 1)
        freedom = self.geometric_freedom(d)

        result = {
            'dimension': d,
            'volume': v_d,
            'surface': s_d,
            'next_surface': s_d1,
            'coupling_ratio': self.coupling_ratio(d),
            'geometric_freedom': freedom,
            'phase': np.arctan2(s_d1, tau * v_d),
            'sv_ratio': s_d / v_d if abs(v_d) > 1e-15 else 0
        }
        return result

    def scan_range(self, start=0, end=15, points=1001):
        dims = np.linspace(start, end, points)
        data = np.zeros((points, 7))

        for i, d in enumerate(dims):
            result = self.analyze_dimension(d)
            data[i] = [
                d,
                result['volume'],
                result['surface'],
                result['next_surface'],
                result['coupling_ratio'],
                result['geometric_freedom'],
                result['phase']
            ]

        return {
            'dimensions': data[:, 0],
            'volumes': data[:, 1],
            'surfaces': data[:, 2],
            'next_surfaces': data[:, 3],
            'coupling_ratios': data[:, 4],
            'freedom': data[:, 5],
            'phases': data[:, 6]
        }

    def find_critical_points(self, start=0, end=15, points=1001):
        scan = self.scan_range(start, end, points)
        dims = scan['dimensions']
        dx = dims[1] - dims[0]

        metrics = {
            'volume': scan['volumes'],
            'surface': scan['surfaces'],
            'freedom': scan['freedom'],
            'coupling': scan['coupling_ratios']
        }

        critical = {}

        for name, values in metrics.items():
            maxima = []
            minima = []
            inflections = []

            d1 = np.gradient(values, dx)
            d2 = np.gradient(d1, dx)

            for i in range(1, len(values) - 1):
                if d1[i - 1] > 0 and d1[i + 1] < 0:
                    maxima.append(dims[i])
                elif d1[i - 1] < 0 and d1[i + 1] > 0:
                    minima.append(dims[i])
                if d2[i - 1] * d2[i + 1] < 0:
                    inflections.append(dims[i])

            critical[name] = {
                'maxima': maxima,
                'minima': minima,
                'inflections': inflections
            }

        return critical

    def interference_pattern(self, d):
        """Track bidirectional phase interference between adjacent dimensions"""
        # Forward volume-to-surface transition
        v_d = self.ball_volume(d)
        s_d1 = self.ball_surface(d + 1)
        forward_phase = np.angle(complex(s_d1, tau * v_d))

        # Backward surface-to-volume transition
        s_d = self.ball_surface(d)
        v_d1 = self.ball_volume(d - 1)
        backward_phase = np.angle(complex(tau * v_d1, s_d))

        # Phase rotation relative to τ-1
        theta = (d - (tau - 1)) / 2 * pi / 2

        # Compute interference between transitions with damping
        interference = np.sin(forward_phase) * np.cos(backward_phase) * np.exp(-((d - tau)**2)/(2*pi))

        # Extract real and imaginary components
        real_component = interference * np.cos(theta)
        imag_component = interference * np.sin(theta)

        # Calculate total geometric freedom
        magnitude = (real_component**2 + imag_component**2)**0.5
        phase = np.angle(complex(real_component, imag_component))

        return magnitude, phase, real_component, imag_component

    def phase_volume(self, d, alpha=1.0):
        """Volume with complex phase rotation"""
        theta = (d - (tau - 1)) / 2 * pi / 2
        z = alpha * (np.cos(theta) + 1j * np.sin(theta))

        try:
            v_base = (pi ** (d / 2)) / gamma(d / 2 + 1)
            v_phase = np.cosh(z.real) + 1j * np.sinh(z.imag)
            return v_base * v_phase
        except:
            return 0

    def rotational_freedom(self, d):
        """Calculate effective rotational freedom at dimension d"""
        v = self.phase_volume(d)
        # For complex d, use phase_volume for surface too
        s = self.phase_volume(d) if isinstance(d, complex) else self.ball_surface(d)

        theta = np.angle(complex(s, tau * abs(v)))
        # Use real part of d for interference calculation
        d_real = d.real if isinstance(d, complex) else d
        interference = np.sin(theta * d_real) * np.cos(pi * d_real / tau)

        r = (abs(v) ** 2 + (abs(s) / tau) ** 2) ** 0.5
        return r * abs(interference)

    def transition_coupling(self, d):
        """Measure coupling strength between adjacent dimensions"""
        v_d = self.phase_volume(d)
        # Handle complex d+1 for surface
        next_d = d + 1
        s_d1 = self.phase_volume(next_d) if isinstance(d, complex) else self.ball_surface(next_d)

        if abs(v_d) < 1e-15:
            return 0

        phase_diff = np.angle(complex(abs(s_d1), tau * abs(v_d)))
        coupling = abs(s_d1) / (tau * abs(v_d))
        return coupling * np.exp(-((phase_diff - pi / 2) ** 2) / (2 * pi))

    def phase_velocity(self, d, delta=0.001):
        """Compute phase velocity and acceleration at dimension d"""
        # Get phases at d±delta
        v_minus = self.ball_volume(d - delta)
        v_center = self.ball_volume(d)
        v_plus = self.ball_volume(d + delta)

        # Phase angles
        theta_minus = np.angle(complex(v_minus, self.ball_surface(d - delta)))
        theta_center = np.angle(complex(v_center, self.ball_surface(d)))
        theta_plus = np.angle(complex(v_plus, self.ball_surface(d + delta)))

        # Compute velocity and acceleration
        velocity = (theta_plus - theta_minus) / (2 * delta)
        accel = (theta_plus - 2*theta_center + theta_minus) / (delta * delta)

        return velocity, accel

    def analyze_complex(self, d):
        """Analyze sphere properties in complex phase space"""
        v = self.phase_volume(d)
        s = self.phase_volume(d) if isinstance(d, complex) else self.ball_surface(d)
        freedom = self.rotational_freedom(d)
        coupling = self.transition_coupling(d)

        return {
            'dimension': d,
            'volume': abs(v),
            'volume_phase': np.angle(v),
            'surface': abs(s),
            'rotational_freedom': freedom,
            'coupling': coupling
        }

def generate_infosheet():
    analyzer = NBallAnalyzer()
    dimensions = analyzer.dimensions()

    # Initialize lists to store metrics for plotting
    metrics = {
        'Volume': [],
        'Surface': [],
        'Coupling Ratio': [],
        'S/V Ratio': [],
        'Geom Freedom': [],
        'Phase': []
    }

    numerical_dims = []

    # Print Header
    print("N-Ball Geometry Analysis Suite")
    print("==================================================\n")

    for d, dname in dimensions:
        numerical_dims.append(d)
        print(f"Dimension d = {dname} ({d})")
        print("----------------------------------------")

        analysis = analyzer.analyze_dimension(d)

        print(f"Volume:          {analysis['volume']:.8f}")
        print(f"Surface:         {analysis['surface']:.8f}")
        print(f"Next Surface:    {analysis['next_surface']:.8f}")
        print(f"Coupling Ratio:  {analysis['coupling_ratio']:.8f}")
        print(f"S/V Ratio:      {analysis['sv_ratio']:.8f}")
        print(f"Geom Freedom:   {analysis['geometric_freedom']:.8f}")
        print(f"Phase:          {analysis['phase']:.8f}\n")

        # Append metrics for plotting
        metrics['Volume'].append(analysis['volume'])
        metrics['Surface'].append(analysis['surface'])
        metrics['Coupling Ratio'].append(analysis['coupling_ratio'])
        metrics['S/V Ratio'].append(analysis['sv_ratio'])
        metrics['Geom Freedom'].append(analysis['geometric_freedom'])
        metrics['Phase'].append(analysis['phase'])

    # Plotting the metrics
    fig, axs = matplotlib.pyplot.subplots(2, 3, figsize=(18, 10))
    fig.suptitle('N-Ball Geometry Metrics Across Dimensions', fontsize=16)

    # Volume
    axs[0, 0].plot(numerical_dims, metrics['Volume'], marker='o', linestyle='-', color='blue')
    axs[0, 0].set_title('Volume vs Dimension')
    axs[0, 0].set_xlabel('Dimension d')
    axs[0, 0].set_ylabel('Volume')
    axs[0, 0].grid(True)

    # Surface
    axs[0, 1].plot(numerical_dims, metrics['Surface'], marker='s', linestyle='-', color='green')
    axs[0, 1].set_title('Surface Area vs Dimension')
    axs[0, 1].set_xlabel('Dimension d')
    axs[0, 1].set_ylabel('Surface Area')
    axs[0, 1].grid(True)

    # Coupling Ratio
    axs[0, 2].plot(numerical_dims, metrics['Coupling Ratio'], marker='^', linestyle='-', color='red')
    axs[0, 2].set_title('Coupling Ratio vs Dimension')
    axs[0, 2].set_xlabel('Dimension d')
    axs[0, 2].set_ylabel('Coupling Ratio')
    axs[0, 2].grid(True)

    # S/V Ratio
    axs[1, 0].plot(numerical_dims, metrics['S/V Ratio'], marker='d', linestyle='-', color='purple')
    axs[1, 0].set_title('S/V Ratio vs Dimension')
    axs[1, 0].set_xlabel('Dimension d')
    axs[1, 0].set_ylabel('S/V Ratio')
    axs[1, 0].grid(True)

    # Geom Freedom
    axs[1, 1].plot(numerical_dims, metrics['Geom Freedom'], marker='*', linestyle='-', color='orange')
    axs[1, 1].set_title('Geometric Freedom vs Dimension')
    axs[1, 1].set_xlabel('Dimension d')
    axs[1, 1].set_ylabel('Geometric Freedom')
    axs[1, 1].grid(True)

    # Phase
    axs[1, 2].plot(numerical_dims, metrics['Phase'], marker='p', linestyle='-', color='brown')
    axs[1, 2].set_title('Phase vs Dimension')
    axs[1, 2].set_xlabel('Dimension d')
    axs[1, 2].set_ylabel('Phase')
    axs[1, 2].grid(True)

    matplotlib.pyplot.tight_layout(rect=[0, 0.03, 1, 0.95])
    matplotlib.pyplot.savefig('nball_geometry_metrics.png')

if __name__ == "__main__":
    generate_infosheet()
